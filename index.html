<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EPG dobleM - 5.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        :root {
            --color-bg-dark-start: #1e1e1e;
            --color-bg-dark-end: #2b2b2b;
            --color-bg-light-start: #f4f4f4;
            --color-bg-light-end: #e6e6e6;
            --color-primary: #00e5ff;
            --color-primary-hover: #00bcd4;
            --color-text-dark: #fff;
            --color-text-light: #000;
            --color-text-muted-dark: #ccc;
            --color-text-muted-light: #333;
            --color-bg-input-dark: #444;
            --color-border-input-dark: #777;
            --color-bg-controls-dark: #2e2e2e;
            --color-bg-controls-light: #ddd;
            --color-bg-card-dark: #1a1a1a;
            --color-bg-card-light: #fff;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--color-text-dark);
            background: linear-gradient(180deg, var(--color-bg-dark-start), var(--color-bg-dark-end));
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        #dateFilter {
            width: auto;
            min-width: 90px;
            max-width: 120px;
            padding: 6px 8px;
            font-size: 1.05em;
            /* tamaño igual para ambos */
            box-sizing: border-box;
        }

        #hourFilter {
            width: auto;
            min-width: 90px;
            max-width: 120px;
            padding: 6px 8px;
            font-size: 0.85em;
            /* tamaño igual para ambos */
            box-sizing: border-box;
        }

        #resetFiltersBtn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            padding: 0;
            font-size: 1.2em;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            border: none;
            background-color: var(--color-primary);
            color: #000;
            transition: background-color 0.3s;
            margin-left: 6px;
        }

        #resetFiltersBtn:hover {
            background-color: var(--color-primary-hover);
        }


        #controls {
            margin-bottom: 25px;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            /* background: var(--color-bg-controls-dark); */
            /* box-shadow: 0 0 8px rgba(0, 0, 0, 0.3); */
        }



        input[type="text"],
        select {
            padding: 10px;
            margin: 8px;
            border-radius: 6px;
            border: 1px solid var(--color-border-input-dark);
            background-color: var(--color-bg-input-dark);
            color: var(--color-text-dark);
            font-size: 0.95em;
            cursor: text;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        button {
            font-size: 1em;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background-color: var(--color-primary);
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--color-primary-hover);
        }

        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        #result-count {
            text-align: center;
            margin: 15px 0;
            font-size: 0.95em;
            color: var(--color-text-muted-dark);
        }

        label {
            font-size: 0.95em;
            color: #ddd;
        }

        .pagination-btn {
            margin: 10px 5px;
        }

        #data-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .program-card {
            background-color: var(--color-bg-card-dark);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 229, 255, 0.3);
            display: flex;
            flex-direction: column;
            color: var(--color-text-dark);
            transition: box-shadow 0.3s ease;
        }

        .program-card:hover {
            box-shadow: 0 4px 16px rgba(0, 229, 255, 0.6);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            margin-bottom: 12px;
        }

        .card-info {
            display: flex;
            gap: 10px;
            align-items: baseline;
            color: var(--color-text-muted-dark);
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        .card-date {
            display: block;
            font-weight: bold;
            color: var(--color-primary);
            font-size: 1.0em;
        }

        .card-time {
            display: block;
            color: var(--color-text-dark);
            font-weight: bold;
            font-size: 0.9em;
        }

        .card-time .duration {
            font-size: 0.8em;
            color: var(--color-text-muted-dark);
            margin-left: 5px;
        }

        .card-channel {
            display: flex;
            align-items: center;
            gap: 1px;
            min-width: 120px;
            flex-direction: row;
        }

        .card-channel img {
            height: 32px;
            width: auto;
            max-width: 60px;
            object-fit: contain;
            border-radius: 1px;
            margin: 0;
            padding: 0;
        }

        .channel-name {
            font-size: 0.75em;
            color: var(--color-text-muted-dark);
        }

        .card-body {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-images {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .card-images img {
            width: 90px;
            border-radius: 6px;
            object-fit: contain;
        }

        .card-text {
            flex: 1;
            min-width: 200px;
        }

        .card-text .title {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 5px;
            color: var(--color-text-dark);
        }

        .card-text .description {
            font-size: 0.85em;
            font-style: italic;
            color: var(--color-text-muted-dark);
            white-space: pre-wrap;
        }

        #top-buttons {
            display: inline-flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: nowrap;
            /* que no se envuelvan */
        }

        input[type="text"],
        select,
        input[type="date"],
        input[type="number"] {
            padding: 10px;
            margin: 8px;
            border-radius: 6px;
            border: 1px solid var(--color-border-input-dark);
            background-color: var(--color-bg-input-dark);
            color: var(--color-text-dark);
            font-size: 0.95em;
            cursor: text;
        }

        #date-hour-filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        #date-hour-filters input,
        #date-hour-filters select {
            flex: 1;
            min-width: 150px;
        }


        /* Loader spinner styles moved to CSS */
        #loader-spinner {
            display: inline-block;
            border: 4px solid var(--color-primary);
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* Light mode overrides */
        body.light-mode {
            background: linear-gradient(180deg, var(--color-bg-light-start), var(--color-bg-light-end));
            color: var(--color-text-light);
        }

        body.light-mode .program-card {
            background-color: var(--color-bg-card-light);
            color: var(--color-text-light);
        }

        body.light-mode .card-date,
        body.light-mode .card-time,
        body.light-mode .card-text .title {
            color: var(--color-text-light);
        }

        body.light-mode .card-text .description {
            color: var(--color-text-muted-light);
        }

        body.light-mode button {
            background-color: var(--color-primary-hover);
            color: var(--color-text-light);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .card-body {
                flex-direction: column;
                align-items: flex-start;
            }

            .card-images {
                flex-direction: row;
                gap: 10px;
            }

            .card-images img {
                width: 70px;
                height: 90px;
                max-width: auto;
                width: auto;
                border-radius: 6px;
                object-fit: cover;
            }

            .card-channel {
                flex-direction: column-reverse;
                align-items: center;
            }

            input[type="text"],
            select,
            button {
                width: 90%;
                margin: 5px auto;
                display: block;
            }

            #controls {
                padding: 10px;
            }

            .card-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .card-time {
                margin-top: 4px;
            }

            /* Nueva regla para la fecha en pantallas pequeñas */
            .card-date {
                font-size: 0.7em !important;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

</head>

<body>
    <h1>EPG dobleM</h1>

    <div id="top-buttons" style="text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: nowrap;">
        <button onclick="toggleViewMode()" id="viewToggleBtn" title="Cambiar vista">📅</button>
        <button onclick="toggleDarkMode()" id="themeToggleBtn" title="Cambiar tema">🌙</button>
        <button onclick="fetchXML()" id="reloadBtn" title="Recargar EPG">🔃</button>
        <button id="uploadXmlBtn" title="Usar otro XML">📂</button>
        <input accept=".xml" type="file" id="fileInput" style="display:none;" />
    </div>

    <div id="controls">
        <select id="channelDropdown">
            <option value="">Seleccionar Canal</option>
        </select>
        <input type="text" id="channelFilter" placeholder="Filtrar por Canal" />
        <input type="text" id="titleFilter" placeholder="Filtrar por Título" />
        <input type="text" id="descriptionFilter" placeholder="Filtrar por Descripción" />
        <div id="dateHourGroup" style="display: inline-flex; gap: 8px; align-items: center;">
            <input type="date" id="dateFilter" />
            <select id="hourFilter">
                <option value="">Hora</option>
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
            </select>
            <button id="resetFiltersBtn" title="Resetear filtros">✖️️</button>
        </div>

    </div>

    <div id="grid-container" style="margin-top: 30px;"></div>


    <div id="loader" style="display: none; text-align:center; margin-top:20px;">
        <span id="loader-spinner"></span>
        <p style="color:#ccc;">Cargando EPG...</p>
    </div>

    <div id="data-list"></div>
    <div id="result-count"></div>

    <script>
        let epgData = [];
        let channelsList = [];
        let filteredData = [];
        let pageSize = 30;
        let renderedItems = 0;

        // Función para obtener la fecha actual en formato YYYY-MM-DD
        function getCurrentDateFormatted() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Los meses son de 0-11
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Función para establecer la fecha actual en el input de fecha
        function setDateToCurrent() {
            document.getElementById('dateFilter').value = getCurrentDateFormatted();
        }

        async function fetchXML() {
            const loader = document.getElementById('loader');
            const reloadBtn = document.querySelector('button[onclick="fetchXML()"]');
            reloadBtn.disabled = true;
            loader.style.display = 'block';

            try {
                const url = 'https://raw.githubusercontent.com/davidmuma/EPG_dobleM/master/EPG_dobleM.xml';
                const response = await fetch(url);
                if (!response.ok) throw new Error("No se pudo cargar el archivo EPG.");
                const xmlText = await response.text();

                // Parsear XML con promesa para no bloquear UI
                await new Promise(resolve => {
                    setTimeout(() => {
                        parseXML(xmlText);
                        resolve();
                    }, 50); // Permite que el loader se pinte antes del parseo pesado
                });

                // Mostrar los primeros 10 resultados rápido
                renderTable(true, 10);

                // Luego cargar el resto en background, sin bloquear UI
                setTimeout(() => {
                    renderTable(false);
                }, 100);

            } catch (err) {
                alert("Error al cargar el EPG: " + err.message);
            } finally {
                loader.style.display = 'none';
                reloadBtn.disabled = false;
            }
        }

        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        parseXML(e.target.result);
                    } catch (err) {
                        alert("Error al analizar el archivo XML: " + err.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        function calculateDuration(start, stop) {
            if (!start || !stop) return '';
            const parseTime = (t) => new Date(`${t.substring(0, 4)}-${t.substring(4, 6)}-${t.substring(6, 8)}T${t.substring(8, 10)}:${t.substring(10, 12)}:00`);
            const startTime = parseTime(start);
            const stopTime = parseTime(stop);
            const diffMinutes = Math.round((stopTime - startTime) / 60000);
            return isNaN(diffMinutes) || diffMinutes <= 0 ? '' : `${Math.floor(diffMinutes / 60)} h ${diffMinutes % 60} min`;
        }

        function parseXML(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
            // Validar errores de parseo del XML
            const parserError = xmlDoc.querySelector('parsererror');
            if (parserError) {
                console.error("Error XML:", parserError.textContent);
                throw new Error("El archivo XML contiene errores.");
            }
            const programmes = xmlDoc.getElementsByTagName('programme');
            epgData = [];

            const channels = {};
            const channelElements = xmlDoc.getElementsByTagName('channel');
            channelsList = [];

            for (let i = 0; i < channelElements.length; i++) {
                const channel = channelElements[i];
                const channelId = channel.getAttribute('id');
                const iconSrc = channel.getElementsByTagName('icon')[0]?.getAttribute('src') || '';
                channels[channelId] = iconSrc;
                channelsList.push(channelId);
            }

            channelsList = [...new Set(channelsList)].sort();
            populateChannelDropdown();

            for (let i = 0; i < programmes.length; i++) {
                const prog = programmes[i];
                const channel = prog.getAttribute('channel') || '';
                const date = formatXMLTVDate(prog.getAttribute('start'));
                const start = formatXMLTVTime(prog.getAttribute('start'));
                const stop = formatXMLTVTime(prog.getAttribute('stop'));
                const duration = calculateDuration(prog.getAttribute('start'), prog.getAttribute('stop'));
                const title = prog.getElementsByTagName('title')[0]?.textContent || '';
                const description = prog.getElementsByTagName('desc')[0]?.textContent || '';
                const iconSrc = prog.getElementsByTagName('icon')[0]?.getAttribute('src') || '';
                const iconSrc2 = prog.getElementsByTagName('icon2')[0]?.getAttribute('src') || '';
                const channelIcon = channels[channel] || '';

                epgData.push({
                    channel,
                    channelIcon,
                    date,
                    start,
                    stop,
                    duration,
                    iconSrc,
                    iconSrc2,
                    title,
                    description
                });
            }

            renderTable(true);
        }

        function formatXMLTVDate(time) {
            if (!time) return '';
            const year = time.substring(0, 4);
            const month = time.substring(4, 6);
            const day = time.substring(6, 8);
            return `${day}/${month}/${year}`;
        }

        function formatXMLTVTime(time) {
            if (!time) return '';
            const hour = time.substring(8, 10);
            const minute = time.substring(10, 12);
            return `${hour}:${minute}`;
        }

        function populateChannelDropdown() {
            const dropdown = document.getElementById('channelDropdown');
            dropdown.innerHTML = '<option value="">Seleccionar Canal</option>';
            channelsList.forEach(channelId => {
                const option = document.createElement('option');
                option.value = channelId;
                option.textContent = channelId;
                dropdown.appendChild(option);
            });
        }

        function renderTable(initial = false, initialPageSize = pageSize) {
            if (initial) {
                // Recalcular filtro y lista filtrada
                const filters = {
                    channel: document.getElementById('channelFilter').value.toLowerCase(),
                    title: document.getElementById('titleFilter').value.toLowerCase(),
                    description: document.getElementById('descriptionFilter').value.toLowerCase(),
                    date: document.getElementById('dateFilter').value,
                    hour: document.getElementById('hourFilter').value
                };

                filteredData = epgData.filter(item => {
                    // Filtros igual que antes...
                    if (filters.channel && !item.channel.toLowerCase().includes(filters.channel)) return false;
                    if (filters.title && !item.title.toLowerCase().includes(filters.title)) return false;
                    if (filters.description && !item.description.toLowerCase().includes(filters.description)) return false;

                    if (filters.date) {
                        const parts = item.date.split('/');
                        const itemDateFormatted = parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : '';
                        if (itemDateFormatted !== filters.date) return false;
                    }

                    if (filters.hour !== '') {
                        const filterHour = parseInt(filters.hour, 10);
                        if (isNaN(filterHour) || filterHour < 0 || filterHour > 23) return false;
                        const itemHour = parseInt(item.start.split(':')[0], 10);
                        if (isNaN(itemHour)) return false;
                        if (itemHour >= filterHour) return true;
                        const itemStopHour = parseInt(item.stop.split(':')[0], 10);
                        if (!isNaN(itemStopHour) && itemHour < filterHour && itemStopHour >= filterHour) return true;
                        return false;
                    }

                    return true;
                });

                renderedItems = 0;
                document.getElementById('data-list').innerHTML = '';
            }

            // Render solo el bloque indicado
            const chunk = filteredData.slice(renderedItems, renderedItems + initialPageSize);
            renderChunk(chunk);
            renderedItems += chunk.length;

            document.getElementById('result-count').textContent = `Mostrando ${filteredData.length} programas`;
        }

        let gridView = false;

        function toggleViewMode() {
            gridView = !gridView;
            document.getElementById('data-list').style.display = gridView ? 'none' : 'block';
            document.getElementById('grid-container').style.display = gridView ? 'block' : 'none';
            document.getElementById('viewToggleBtn').textContent = gridView ? '📋' : '📅';
            if (gridView) {
                renderCurrentView();
            }
        }

        function renderCurrentView() {
            if (gridView) {
                document.getElementById('data-list').style.display = 'none';
                document.getElementById('grid-container').style.display = 'block';
                renderTable(true); // Para actualizar filteredData
                renderGridView(); // Para dibujar la grilla
            } else {
                document.getElementById('grid-container').style.display = 'none';
                document.getElementById('data-list').style.display = 'block';
                renderTable(true);
            }
        }

        function renderGridView() {
            const container = document.getElementById('grid-container');
            container.innerHTML = ''; // Limpiar contenido previo

            // Agrupar por canal
            const grouped = {};
            filteredData.forEach(item => {
                if (!grouped[item.channel]) grouped[item.channel] = [];
                grouped[item.channel].push(item);
            });

            // Crear tabla
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.tableLayout = 'fixed'; // ¡Añade esta línea!

            // Encabezado de horas
            const hoursRow = document.createElement('tr');
            hoursRow.innerHTML = `<th style="width: 120px; white-space: nowrap;">Canal</th>`; // Añadido white-space para el encabezado
            for (let h = 0; h < 24; h++) {
                hoursRow.innerHTML += `<th style="width: 120px; font-size: 0.8em;">${String(h).padStart(2, '0')}:00</th>`; // <-- Añadido font-size
            }
            table.appendChild(hoursRow);

            // Filas por canal
            for (const [channel, programs] of Object.entries(grouped)) {
                const row = document.createElement('tr');

                // Celda canal
                const channelCell = document.createElement('td');
                channelCell.style.padding = '5px';
                channelCell.style.background = '#222';
                channelCell.style.color = '#FFFFFF'; // <-- Cambiado a blanco (#FFFFFF)
                channelCell.style.verticalAlign = 'middle';

                // --- INICIO CAMBIO ICONO/NOMBRE DEL CANAL ---
                const channelIconSrc = programs[0]?.channelIcon || ''; // Obtener el icono del primer programa para este canal
                const channelName = channel;

                if (channelIconSrc) {
                    const img = document.createElement('img');
                    img.src = channelIconSrc;
                    img.alt = channelName;
                    img.style.height = '32px';
                    img.style.width = 'auto';
                    img.style.maxWidth = '60px';
                    img.style.display = 'block';
                    img.style.margin = '0 auto 2px auto';
                    channelCell.appendChild(img);
                }

                const nameDiv = document.createElement('div');
                nameDiv.textContent = channelName;
                nameDiv.style.fontSize = '0.75em';
                nameDiv.style.textAlign = 'center';
                channelCell.appendChild(nameDiv);
                // --- FIN CAMBIO ICONO/NOMBRE DEL CANAL ---

                row.appendChild(channelCell);

                const cells = new Array(24).fill(null);

                programs.forEach(program => {
                    const startHour = parseInt(program.start.split(':')[0], 10);
                    // Re-calcula la duración en horas fraccionadas para un mejor ajuste del span
                    // Asegúrate de que la fecha se parsea correctamente para el cálculo de la duración
                    const dateParts = program.date.split('/');
                    const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // Convertir a YYYY-MM-DD
                    const startTime = new Date(`${formattedDate}T${program.start}:00`);
                    const stopTime = new Date(`${formattedDate}T${program.stop}:00`);
                    const diffMinutes = Math.round((stopTime - startTime) / 60000);
                    // Asegura un span mínimo de 1 hora si la duración es muy corta o inválida
                    const durationInHours = Math.max(1, diffMinutes / 60); // Ajusta a 1 como mínimo

                    const title = program.title || '';
                    const col = document.createElement('td');
                    // Span de columnas basado en la duración, redondeando a la hora más cercana o media hora para una mejor visualización
                    col.colSpan = Math.max(1, Math.round(durationInHours)); // Redondear a la hora más cercana para colspan

                    col.style.background = '#333';
                    col.style.color = '#fff';
                    col.style.textAlign = 'center';
                    col.style.border = '1px solid #444';
                    // Nuevo código para la celda del programa (col)
                    // ...
                    col.style.padding = '2px';
                    col.style.overflow = 'hidden'; // Puedes mantenerlo si quieres que no se "desborde" fuera del borde de la celda, pero el texto se ajustará.
                    // col.style.whiteSpace = 'nowrap';    // ELIMINADA
                    // col.style.textOverflow = 'ellipsis'; // ELIMINADA
                    col.style.verticalAlign = 'top';
                    col.style.whiteSpace = 'normal'; // Opcional: Asegura que el texto se rompa normalmente
                    col.style.wordWrap = 'break-word'; // Opcional: Para romper palabras largas si es necesario
                    // ...

                    // --- INICIO CAMBIO TÍTULO/HORA DEL PROGRAMA ---
                    const titleDiv = document.createElement('div');
                    titleDiv.textContent = title;
                    titleDiv.style.fontWeight = 'bold'; // Haz que el título resalte
                    titleDiv.style.fontSize = '0.85em'; // Mantén el tamaño de fuente actual para el título
                    col.appendChild(titleDiv);

                    const timeDiv = document.createElement('div');
                    // Formato para mostrar: "DD/MM/YYYY HH:MM - HH:MM"
                    timeDiv.textContent = `${program.date} ${program.start} - ${program.stop}`;
                    timeDiv.style.fontSize = '0.7em'; // Tamaño de fuente más pequeño para las horas
                    timeDiv.style.color = '#ccc'; // Color más claro para las horas
                    timeDiv.style.marginTop = '2px'; // Pequeño margen encima de las horas
                    col.appendChild(timeDiv);
                    // --- FIN CAMBIO TÍTULO/HORA DEL PROGRAMA ---

                    // Marcar como ocupado para no sobreescribir
                    cells[startHour] = col;

                    for (let i = 1; i < col.colSpan; i++) {
                        if (startHour + i < 24) {
                            cells[startHour + i] = 'occupied';
                        }
                    }
                });

                // Agregar las 24 columnas
                for (let h = 0; h < 24; h++) {
                    if (cells[h] && cells[h] !== 'occupied') {
                        row.appendChild(cells[h]);
                        h += cells[h].colSpan - 1; // Avanzar el contador de la hora
                    } else if (cells[h] === null) { // Si la celda no está ocupada y es nula
                        const empty = document.createElement('td');
                        empty.style.border = '1px solid #444';
                        empty.innerHTML = '&nbsp;';
                        row.appendChild(empty);
                    }
                    // Si cells[h] es 'occupied', significa que ya fue añadida por una celda anterior, no hacer nada.
                }

                table.appendChild(row);
            }

            container.appendChild(table);
        }


        function renderChunk(data) {
            const dataList = document.getElementById('data-list');
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'program-card';
                card.innerHTML = `
          <div class="card-header">
            <div class="card-info">
              <div class="card-date">${item.date}</div>
              <div class="card-time">${item.start} - ${item.stop} ${item.duration ? `<span class="duration">(${item.duration})</span>` : ''}</div>
            </div>
            <div class="card-channel">
              ${item.channelIcon ? `<img src="${item.channelIcon}" alt="${item.channel}">` : ''}
              <div class="channel-name">${item.channel}</div>
            </div>
          </div>
          <div class="card-body">
            <div class="card-images">
              ${item.iconSrc ? `<img src="${item.iconSrc}" alt="Imagen de ${item.title}">` : ''}
              ${item.iconSrc2 ? `<img src="${item.iconSrc2}" alt="Imagen 2 de ${item.title}">` : ''}
            </div>
            <div class="card-text">
              <div class="title">${item.title}</div>
              <div class="description">${item.description}</div>
            </div>
          </div>
        `;
                dataList.appendChild(card);
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('themeToggleBtn').textContent = isLight ? '☀️' : '🌙';
        }

        document.getElementById('uploadXmlBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        // Filtros
        document.getElementById('channelDropdown').addEventListener('input', () => {
            document.getElementById('channelFilter').value = document.getElementById('channelDropdown').value;
            renderCurrentView();
        });

        document.getElementById('dateFilter').addEventListener('input', () => {
            renderTable(true);
        });

        document.getElementById('hourFilter').addEventListener('input', () => {
            renderTable(true);
        });

        document.getElementById('resetFiltersBtn').addEventListener('click', () => {
            // Limpiar todos los filtros
            document.getElementById('channelDropdown').value = '';
            document.getElementById('channelFilter').value = '';
            document.getElementById('titleFilter').value = '';
            document.getElementById('descriptionFilter').value = '';
            // Establecer la fecha al día actual
            setDateToCurrent();
            document.getElementById('hourFilter').value = '';
            renderCurrentView();
        });


        // Evitar renderizados excesivos con debounce
        function debounce(func, delay = 300) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Aplica debounce a los filtros de texto
        ['channelFilter', 'titleFilter', 'descriptionFilter', 'dateFilter', 'hourFilter'].forEach(id => {
            document.getElementById(id).addEventListener('input', debounce(() => {
                document.getElementById('channelDropdown').value = '';
                renderCurrentView();
            }));
        });

        // Scroll infinito
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 200)) {
                renderTable(false);
            }
        });

        // Llama a setDateToCurrent al cargar la página para establecer la fecha inicial
        document.addEventListener('DOMContentLoaded', setDateToCurrent);

        fetchXML();
    </script>
</body>


</html>
